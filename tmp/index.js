"use strict";mapboxgl.accessToken="pk.eyJ1IjoiZGlwbG9kb2N1cyIsImEiOiJVS3Awd0VjIn0.h-4kf2_aTY_dGxyImqy2DA";var ecodistrict=angular.module("ecodistrict",["geolocation"]);ecodistrict.controller("mapCtrl",["$scope","$http","$sce","geolocation","$timeout",function(a,b,c,d,e){var f="./api",g={center:[6.191492,48.678574],zoom:10.8,pitch:0};a.display_modes=[],a.current_display_mode=!1,a.show_pois=!1;var h=!1,i=!1,j=!1,k=[],l=[],m=new mapboxgl.Map({container:"map-container",style:"mapbox://styles/mapbox/light-v8",center:g.center,zoom:g.zoom,pitch:g.pitch});m.dragRotate.disable();var n=5e3;a.status="start",a.getLocation=function(){d.getLocation({enableHighAccuracy:!0,timeout:1e4,maximumAge:72e6}).then(function(a){}),e(function(){a.status="located",m.easeTo({zoom:17,center:[6.200071,48.693726],duration:n,pitch:50})},1e3),a.status="locating"},a.quitLocation=function(){m.easeTo({center:g.center,zoom:11.5,pitch:g.pitch,duration:n}),a.status="start"};var o=function(){b({method:"GET",url:f}).success(function(b,c){h=!0,a.display_modes=b.display_modes,a.current_display_mode=b.display_modes[0],l=b.pois,k=b.districts_shapes,u()}).error(function(a,b){})};o();var p=[],q=function(b,c){_.each(p,function(a){m.removeSource(a),m.removeLayer(a)}),p=[];var d=20,e=b.districts_values_min_color?tinycolor(b.districts_values_min_color):tinycolor({r:255,g:255,b:255,a:0}),f=b.districts_values_max_color?tinycolor(b.districts_values_max_color):tinycolor({r:255,g:255,b:255,a:0});a.color_min=e.toRgbString(),a.color_max=f.toRgbString();for(var g=[],h=0;d>h;h++)g.push(tinycolor.mix(e,f,h/(d-1)*100));var i=_.pluck(b.districts_values,"value"),j=_.min(i),l=_.max(i);_.each(b.districts_values,function(a){_.isNumber(a.alpha)||(a.alpha=(a.value-j)/(l-j))}),b.chiant&&(b.districts_values=_.sortBy(b.districts_values,"alpha"),_.each(b.districts_values,function(a,c){a.alpha=c/(b.districts_values.length-1)})),_.each(b.districts_values,function(a){a.color_num=Math.round(a.alpha*(d-1))});var n=_.groupBy(_.sortBy(b.districts_values,"color_num"),"color_num");_.each(n,function(a){var b=a[0].color_num,c=new mapboxgl.GeoJSONSource({type:"geojson",data:{type:"FeatureCollection",features:_.map(a,function(a){return{type:"Feature",properties:{id:a.id,infobubble:a.infobubble},geometry:_.findWhere(k,{id:a.id}).geometry}})}});m.addSource("districts_group_"+b,c),m.addLayer({id:"districts_group_"+b,type:"fill",source:"districts_group_"+b,interactive:!0,paint:{"fill-outline-color":"#FFFFFF","fill-color":g[b].toHexString(),"fill-opacity":g[b].getAlpha()}}),p.push("districts_group_"+b)})};a.pois_types=[["Chauffage","#e74c3c"],["Isolation","#3498db"]];var r=[],s=function(){var b=_.groupBy(l,function(a){return"type"+a.type+(a.big?"big":"small")});b=_.sortBy(b,function(a){return(a[0].big?1e3:1)+a[0].type}),t(),_.each(b,function(b,c){var d="pois"+c,e=b[0],f=new mapboxgl.GeoJSONSource({type:"geojson",data:{type:"FeatureCollection",features:_.map(b,function(a){return{type:"Feature",properties:{infobubble:a.infobubble},geometry:{type:"Point",coordinates:[a.lon,a.lat]}}})}});m.addSource(d,f);var g=a.pois_types[e.type][1];g||(g=a.pois_types[0][1]);var h=3,i=10,j=25;m.addLayer({id:d,type:"circle",interactive:!0,infobubble:e.infobubble,source:d,paint:{"circle-radius":e.big?j:i,"circle-color":"#ffffff"}}),m.addLayer({id:"over"+d,type:"circle",source:d,paint:{"circle-radius":(e.big?j:i)-h,"circle-color":g}}),r.push(d)})},t=function(){_.each(r,function(a){m.removeSource(a),m.removeLayer(a),m.removeLayer("over"+a)}),r=[]};a.infobubble=!1,m.on("click",function(b){m.featuresAt(b.point,{radius:15},function(b,d){var e=!1;d.length&&(e=d[d.length-1],console.log(e),e.properties&&e.properties.infobubble&&(a.infobubble=c.trustAsHtml(e.properties.infobubble),a.$apply()))})}),a.closeInfobubble=function(){a.infobubble=!1};var u=function(){i&&h&&(q(a.current_display_mode),a.show_pois?s():t(),j=!0)};a.$watch("current_display_mode",function(b){j&&(q(b),a.show_pois?s():t())}),a.$watch("show_pois",function(a){j&&(a?s():t())}),m.on("load",function(b){i=!0,u(),a.$apply()})}]);